---
title: "Data exploration"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
```

# Loading data



```{r ilposdata}

load("../data/ilposdata.RData")
# load("../data/ilposdata.Rdata")

load("../data/paavodata.RData")

rename(ilposdata, sex= gender)
```

# table 1 
```{r}


#table 1 
library(arsenal)

tab1 <- tableby(gender ~ Hb + age+ aborh + age.group + FirstEvent, data=ilposdata)
summary(tab1, text=T)
results="asis"

# remove p-values + missing values and make it look prettier
```


# Preprocessing

You can also embed plots, for example:
## Donation data

```{r pressure, echo=FALSE}
nb_donations_data <-
  ilposdata %>% 
    mutate(Year = year(dateonly)) %>% 
    filter(donat_phleb == "K") %>% 
    count(donor,Year, zip)
 
 summarised_donor_data <- 
  ilposdata %>% 
    mutate(Year = year(dateonly),
           Hb = ifelse(is.nan(Hb), NA, Hb)) %>% 
    group_by(donor, Year, zip) %>% 
    summarize(mean_hb=mean(Hb, na.rm = TRUE)) %>% 
   drop_na(mean_hb) %>% 
   full_join(nb_donations_data,
             by = c("donor", "zip","Year")) %>% 
   mutate(n = replace_na(n, 0))

```

## Paavo data
```{r}
preprocessed_paavo_data <- 
  paavodata %>% 
    dplyr::select(pono, vuosi, hr_mtu, hr_ktu,nimi) %>% 
    rename(zip = pono,
           Year= vuosi,
           medianincome= hr_mtu,
           averageincome= hr_ktu,
           Zipname= nimi)
```



```{r}
final_data <-
  left_join(summarised_donor_data,
            preprocessed_paavo_data,
            by = c("zip", "Year")) %>% 
  filter(Year > 2014)
```

# Preliminary plots

```{r}
final_data %>% 
  ggplot(aes(x = medianincome)) +
  geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )
```
```{r}
final_data %>% 
  ggplot(aes(x = averageincome)) +
  geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )
```


```{r}
final_data %>% 
  ggplot(aes(x = averageincome)) +
  geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. ) +
  scale_y_log10()
```

```{r}
final_data %>% 
  ggplot(aes(x = Year, y = averageincome)) +
  geom_jitter(alpha = 0.2)
```

# educational, living arragements and job-status  distributions
```{r} 
#add educational data to paavodata and combine the education data to 3 categories: 1) basic level 2) Matriculation examination and vocational diploma, 3) university degree (higher and lower)

preprocessed_paavo_data <- 
  paavodata %>% 
    dplyr::select(pono, vuosi, hr_mtu, hr_ktu,nimi, ko_perus, ko_yliop, ko_ammat, ko_al_kork, ko_yl_kork, pt_tyott, pt_opisk, pt_tyoll, te_omis_as, te_vuok_as) %>% 
    rename(zip = pono,
           Year= vuosi,
           Basiceducation=ko_perus,
           unemployed = pt_tyott,
           students = pt_opisk,
           employed = pt_tyoll,
           owner_apartment = te_omis_as,
           rental_apartment = te_vuok_as)

#Remove the old variables, which were combined
preprocessed_paavo_data["secondaryeducation"] <- rowSums(preprocessed_paavo_data[c("ko_yliop",
                                  "ko_ammat")])
preprocessed_paavo_data["tertiaryeducation"] <- rowSums(preprocessed_paavo_data[c("ko_al_kork",
                                 "ko_yl_kork")])

preprocessed_paavo_data <- subset(preprocessed_paavo_data, select=-c(ko_yliop,
                                                                     ko_ammat,
                                                                     ko_al_kork,
                                                                     ko_yl_kork))


final_data <-
  left_join(final_data,
            preprocessed_paavo_data,
            by = c("zip", "Year")) %>% 
  filter(Year > 2014)
```


```{r} 
final_data %>% 
ggplot(aes(x = Basiceducation)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )
```
```{r}
final_data %>% 
ggplot(aes(x = secondaryeducation)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )

```

```{r}
final_data %>% 
ggplot(aes(x = tertiaryeducation)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )
```

# Plotting housing variables 
```{r}
final_data  %>% 
ggplot(aes(x = owner_apartment)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )

final_data  %>% 
ggplot(aes(x = rental_apartment)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )

```

# Plotting main type of activity 
```{r}
final_data  %>% 
ggplot(aes(x = unemployed)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )

final_data  %>% 
ggplot(aes(x = employed)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )

final_data  %>% 
ggplot(aes(x = students)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )


```


  
# summarised by hb 
```{r}

hb_by_zip <- final_data %>% 
  group_by(zip, Year) %>% 
  summarise(mean_hb=mean(mean_hb)) 

hb_by_zip %>% 
  ggplot(aes(x = Year, y = mean_hb)) +
  geom_jitter(alpha = 0.2)


```
#   Added gender and deferrals and blood groups to the data + Plotting income(db) by gender
```{r}
blood_def_gender <-ilposdata %>% 
count(gender, Hb_deferral, aborh) %>% 
inner_join(ilposdata)
  
```


# First time donors
```{r}

```



# correlation matrix and plots

```{r}
library("GGally")





```


# Compare the income distribution of blood donors to Finnish average distribution

```{r}

```

# Count division of post codes between mobile and fixed sites.  (Calculate the average distance between zip code and donation site for modelling purposes). 
```{r}

```


# Standard deviation and normal distribution 