---
title: "Data exploration"
output: github_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
```

# Loading data



```{r ilposdata}

load("../data/ilposdata.RData")
# load("../data/ilposdata.Rdata")

load("../data/paavodata.RData")

rename(ilposdata, sex= gender )

rm(aluejakokartat,cc,Data,hoobee_data,nb_donations_data,paavo,paavo_shares,paavo_vars,paavo18,preprocessed_paavo_data,summarised_donor_data,zipcode_maps,api_key,columns_to_mutate,corvallis,file,hb_data,helsinki,i,results,share_column_suffix,sp.vaesto,collapse_names,data,get_geo,map_fi_zipcode,map_fi_zipcode_interactive,order_columns,paavo_aggr,sum_finite,wmean,zip_code_map,fi_commune_number2name)

```

# table 1 
```{r}


#table 1 
library(arsenal)

tab1 <- tableby(gender ~ Hb + age+ aborh + age.group + FirstEvent, data=ilposdata)
summary(tab1, text=T)
results="asis"

# remove p-values + missing values and make it look prettier
```


# Preprocessing

You can also embed plots, for example:
## Donation data
```{r pressure, echo=FALSE}
nb_donations_data <-
  ilposdata %>% 
    mutate(Year = year(dateonly)) %>% 
    filter(donat_phleb == "K") %>% 
    count(donor,Year, zip)
 
 summarised_donor_data <- 
  ilposdata %>% 
    mutate(Year = year(dateonly),
           Hb = ifelse(is.nan(Hb), NA, Hb)) %>% 
    group_by(donor, Year, zip) %>% 
    summarize(mean_hb=mean(Hb, na.rm = TRUE),
              aborh=last(aborh),
              gender=last(gender),
              age=last(age)
                           ) %>% 
   drop_na(mean_hb) %>% 
   full_join(nb_donations_data,
             by = c("donor", "zip","Year")) %>% 
   mutate(n = replace_na(n, 0))

```

## Paavo data
```{r}
preprocessed_paavo_data <- 
  paavodata %>% 
    dplyr::select(pono, vuosi, hr_mtu, hr_ktu,nimi, ko_perus, ko_yliop, ko_ammat, ko_al_kork, ko_yl_kork, pt_tyott, pt_opisk, pt_tyoll, te_omis_as, te_vuok_as,he_vakiy, ko_ika18y,hr_pi_tul,hr_ke_tul,hr_hy_tul,) %>% 
    rename(zip = pono,
           Year= vuosi,
           Basiceducation=ko_perus,
           unemployed = pt_tyott,
           students = pt_opisk,
           employed = pt_tyoll,
           owner_apartment = te_omis_as,
           rental_apartment = te_vuok_as,
           medianincome= hr_mtu,
           averageincome= hr_ktu,
           population= he_vakiy,
           population18= ko_ika18y,
           lowestincome= hr_pi_tul,
           middleincome=hr_ke_tul,
            )

#Remove the old variables, which were combined
preprocessed_paavo_data["secondaryeducation"] <- rowSums(preprocessed_paavo_data[c("ko_yliop",
                                  "ko_ammat")])
preprocessed_paavo_data["tertiaryeducation"] <- rowSums(preprocessed_paavo_data[c("ko_al_kork",
                                 "ko_yl_kork")])

preprocessed_paavo_data <- subset(preprocessed_paavo_data, select=-c(ko_yliop,
                                                           ko_ammat, ko_al_kork,
                                                                     ko_yl_kork))




final_data <-
  left_join(summarised_donor_data,
            preprocessed_paavo_data,
            by = c("zip", "Year")) %>% 
  filter(Year > 2014)
```

# Preliminary plots

```{r}
final_data %>% 
  ggplot(aes(x = medianincome)) +
  geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )


final_data %>% 
  ggplot(aes(x = averageincome)) +
  geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )
```


```{r}
final_data %>% 
  ggplot(aes(x = averageincome)) +
  geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. ) +
  scale_y_log10()
```

```{r}
final_data %>% 
  ggplot(aes(x = Year, y = averageincome)) +
  geom_jitter(alpha = 0.2)
```
# income distribution Households belonging to the highes tincome category,Households earning more than EUR 34 550 per year (deciles9-10).Incomecategoriesare formed by usingd eciles.The decile sare forme dby listing all persons included in the dwelling populationC onceptd efinitionin order basedon their equivalentd isposable income and dividing them to ten shares that contain an equal amount of persons.Equivalenti ncome is an income concept by which incomes of households of different typesa remad ecomparable by taking account o  shared consumptionbenefits.Equivalent income=  the household's income divided by the number of consumptionunit s in thehousehohold
```{r}
final_data %>%
group_by(zip,hr_hy_tul) %>% 
ggplot(aes(x= hr_hy_tul, y= population18))+
geom_line() +
facet_grid(Year ~.)
```




```{r} 
final_data %>% 
ggplot(aes(x = Basiceducation)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )


```
```{r}
final_data %>% 
ggplot(aes(x = secondaryeducation)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )

```

```{r}
final_data %>% 
ggplot(aes(x = tertiaryeducation)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )
```

# Plotting housing variables 
```{r}
final_data  %>% 
ggplot(aes(x = owner_apartment)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )

final_data  %>% 
ggplot(aes(x = rental_apartment)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )

```

# Plotting main type of activity 
```{r}
final_data  %>% 
ggplot(aes(x = unemployed)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )

final_data  %>% 
ggplot(aes(x = employed)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )

final_data  %>% 
ggplot(aes(x = students)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )


```


  
# summarised by hb 
```{r}

hb_by_zip <- final_data %>% 
  group_by(zip, Year) %>% 
  summarise(mean_hb=mean(mean_hb)) 

hb_by_zip %>% 
  ggplot(aes(x = Year, y = mean_hb)) +
  geom_jitter(alpha = 0.2)


```






# correlation matrix and plots
#Paavodata 
```{r}
library("GGally")


varspaavo <- c("medianincome","averageincome","tertiaryeducation","secondaryeducation","rental_apartment", "employed","unemployed","Basiceducation")

ggpairs(final_data,columns= varspaavo)



```
#correlation matrix with donor data 

```{r}
donorvars <- c ("Hb","age","gender","aborh")
ggpairs(ilposdata, columns= donorvars)
```
#ggpairs with both datasets
```{r}
varboth <-  c( "mean_hb", "tertiaryeducation","medianincome","unemployed")
ggpairs(final_data, columns= varboth)

```


Correlation matrix and  plots on final data with psycho package
```{r}
library(psycho)
library(tidyverse)

 
cor <- correlation (final_data) 


plot(cor)
summary(cor)
```

# Compare the  distribution of blood donors to Finnish average distribution.


1) #Divide the number of donors from zipcode by the total number of potential donors
```{r}

```


# Count division of post codes between mobile and fixed sites.  
```{r}

    Sitedata <- ilposdata %>%
    mutate(locSim = case_when(
      Site == "H0091" | Site == "H0092" ~ "Kivihaka",
      Site == "H0093"  ~ "Sanomatalo",
      Site == "H0096"  ~ "Espoo",
      Site == "K0297" ~ "Kuopio",
      Site == "T0837" ~ "Tampere",
      Site == "T07343" ~ "Seinäjoki",
      Site == "T0179" ~ "Jyväskylä",
      Site == "T0398" ~ "Lahti",
      Site == "L0564" ~ "Oulu",
       Site == "U0853" ~ "Turku",
      TRUE ~ "mobilesite"), 
      locSim2= ifelse(locSim !="Other","Studysite","Other"))

  
 Sitedata %>% 
mutate(Year = year(dateonly)) %>% 
filter(donat_phleb == "K") %>% 
filter(Year > 2015) %>% 
count(locSim, Year) %>% 

   
 # make a new variable (fixedsites or plot without mobilesites)
 


```
## This part is copied from frcbs github folder. Only difference is that all plots are filtered with year < 2014 and full bloo
 
```{r}
lifetime_donation_data<- 
  ilposdata %>% 
    filter(donat_phleb == ("K"))  %>% 
   mutate(Year = year(dateonly))


lifetime_donation_data %>% 
  group_by(Year, gender) %>% 
  summarize(mean_Hb = mean(Hb, na.rm = TRUE),
            nb_Hb_deferrals = sum(as.numeric(Hb_deferral) - 1)) %>% 
  gather(key = key, value = value, -Year, -gender) %>% 
  ggplot(aes(x = Year, y = value)) +
  geom_point() +
  geom_line() +
  facet_grid(key ~gender, scales = "free")
```

## Distribution of donation frequency across donor
```{r}

lifetime_donation_data %>% 
  group_by(Year, gender, donor) %>% 
  summarize(nb_donations = n()) %>% 
  # gather(key = key, value = value, -Year, -sex) %>% 
  ggplot(aes(x = as.factor(Year), y = nb_donations)) +
  geom_count() +
  # geom_line() +
  facet_grid(gender ~., scales = "free")

```

```{r}
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

lifetime_donation_data %>% 
  inner_join(nb_donations_per_year_data, by = c("donor", "Year")) %>% 
  mutate(group = case_when(gender == "Women" & age < 40 ~ "U40 Women",
                           gender == "Women" & age >= 40 ~ "40+ Women",
                           TRUE ~"Men")) %>% 
  rename(yearly_donations = nb_donations) %>% 
  group_by(group, Year, yearly_donations, donor) %>% 
  ungroup() %>% 
  group_by(group, Year, yearly_donations) %>% 
  summarise(nb_donors = n()) %>% 
  ungroup() %>% 
  mutate(group = ordered(group, levels = c("U40 Women", "40+ Women", "Men"))) %>% 
  ggplot(aes(x = Year, y = nb_donors, color = as.factor(yearly_donations),  group = as.factor(yearly_donations))) +
  geom_point() + 
  geom_line() +
  scale_y_log10(breaks =c(100, 500, 1000, 2500,  5000, 10000)) +
  scale_color_manual(values=cbPalette) +
  facet_grid(group ~., scales = "free")
```

 
```{r}
donations_nb_data <-
  lifetime_donation_data %>% 
    inner_join(nb_donations_per_year_data, by = c("donor", "Year")) %>% 
    mutate(group = case_when(gender == "Women" & age < 40 ~ "U40 Women",
                             gender == "Women" & age >= 40 ~ "40+ Women",
                             TRUE ~"Men")) %>% 
    rename(yearly_donations = nb_donations) %>% 
    group_by(group, Year, yearly_donations, donor) %>% 
    ungroup() %>% 
    group_by(group, Year, yearly_donations) %>% 
    summarise(nb_donors = n()) %>% 
    ungroup() %>% 
    mutate(group = ordered(group, levels = c("U40 Women", "40+ Women", "Men")))
```


  
```{r}
ylab = c(0,50,100)
  donations_nb_data %>% 
  mutate(total_donations = yearly_donations*nb_donors) %>% 
  ggplot(aes(x = as.character(Year), y = total_donations, fill = as.character(yearly_donations))) +
  geom_col() +
  facet_grid(group ~.) +
  # scale_y_continuous(labels = scales::unit_format("k", 1e-3)) +
   scale_y_continuous(labels = paste0(ylab, "K"),
                     breaks = 1000 * ylab)
```

```{r}
 donations_nb_data %>% 
  mutate(total_donations = yearly_donations*nb_donors) %>% 
  ggplot(aes(x = as.character(Year), y = total_donations, 
             color = as.character(yearly_donations),
             group = as.character(yearly_donations))) +
    geom_point() +
    geom_line() +
    scale_color_manual(values=cbPalette) +
    facet_grid(group ~., scales = "free") +
    theme_bw() +
    xlab("Year") +
    ylab("Total number of donations") +
    guides(color = guide_legend(title = "Nb of yearly \n donations")) +
    theme(text = element_text(size =18)) 
    # scale_color_colorblind()
```
  
    
```{r}
donations_nb_data %>% 
  mutate(total_donations = yearly_donations*nb_donors) %>% 
  group_by(Year) %>% 
  mutate(perc_donations = total_donations/sum(total_donations)) %>% 
    ggplot(aes(x = as.character(Year), y = perc_donations, fill = as.character(yearly_donations))) +
  geom_col(position = position_dodge()) +
  facet_grid(group ~.) +
  theme_bw() +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = "Yearly donations"),
         nrow = 1)
```
      
  
   #missing donations overall
```{r}

donations_nb_data %>% 
  mutate(total_donations = yearly_donations*nb_donors,
         total_donation_sim = ifelse(group == "U40 Women" & yearly_donations > 2,
                                     nb_donors*2,
                                     nb_donors*yearly_donations)) %>% 
  group_by(Year) %>% 
  summarise(total_donations = sum(total_donations),
            total_donation_sim = sum(total_donation_sim),
            lost_donations = total_donations - total_donation_sim) %>% 
  # gather(key = key, value = nb_donations,  -Year) %>% 
  ggplot(aes(x = as.factor(Year), y = lost_donations)) +
  geom_col(alpha = 0.5) +
  theme_bw()+
  xlab("Year") +
  ylab("Missing donations") +
  theme(text = element_text(size = 18))
```
```
  

  
  



 


