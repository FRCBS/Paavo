---
title: "Data exploration"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
```

# Loading data



```{r ilposdata}

load("../data/ilposdata.RData")
# load("../data/ilposdata.Rdata")

load("../data/paavodata.RData")

rename(ilposdata, sex= gender )

rm(aluejakokartat,cc,Data,hoobee_data,nb_donations_data,paavo,paavo_shares,paavo_vars,paavo18,preprocessed_paavo_data,summarised_donor_data,zipcode_maps,api_key,columns_to_mutate,corvallis,file,hb_data,helsinki,i,results,share_column_suffix,sp.vaesto,collapse_names,data,get_geo,map_fi_zipcode,map_fi_zipcode_interactive,order_columns,paavo_aggr,sum_finite,wmean,zip_code_map,fi_commune_number2name)

```

# table 1 
```{r}


#table 1 
library(arsenal)

tab1 <- tableby(gender ~ Hb + age+ aborh + age.group + FirstEvent, data=ilposdata)
summary(tab1, text=T)
results="asis"

# remove p-values + missing values and make it look prettier
```


# Preprocessing

You can also embed plots, for example:
## Donation data

```{r pressure, echo=FALSE}
nb_donations_data <-
  ilposdata %>% 
    mutate(Year = year(dateonly)) %>% 
    filter(donat_phleb == "K") %>% 
    count(donor,Year, zip)
 
 summarised_donor_data <- 
  ilposdata %>% 
    mutate(Year = year(dateonly),
           Hb = ifelse(is.nan(Hb), NA, Hb)) %>% 
    group_by(donor, Year, zip) %>% 
    summarize(mean_hb=mean(Hb, na.rm = TRUE),
              aborh=last(aborh),
              gender=last(gender)
                           ) %>% 
   drop_na(mean_hb) %>% 
   full_join(nb_donations_data,
             by = c("donor", "zip","Year")) %>% 
   mutate(n = replace_na(n, 0))

```

## Paavo data
```{r}
preprocessed_paavo_data <- 
  paavodata %>% 
    dplyr::select(pono, vuosi, hr_mtu, hr_ktu,nimi, ko_perus, ko_yliop, ko_ammat, ko_al_kork, ko_yl_kork, pt_tyott, pt_opisk, pt_tyoll, te_omis_as, te_vuok_as,he_vakiy, ko_ika18y) %>% 
    rename(zip = pono,
           Year= vuosi,
           Basiceducation=ko_perus,
           unemployed = pt_tyott,
           students = pt_opisk,
           employed = pt_tyoll,
           owner_apartment = te_omis_as,
           rental_apartment = te_vuok_as,
           medianincome= hr_mtu,
           averageincome= hr_ktu,
           population= he_vakiy,
           population18= ko_ika18y)

#Remove the old variables, which were combined
preprocessed_paavo_data["secondaryeducation"] <- rowSums(preprocessed_paavo_data[c("ko_yliop",
                                  "ko_ammat")])
preprocessed_paavo_data["tertiaryeducation"] <- rowSums(preprocessed_paavo_data[c("ko_al_kork",
                                 "ko_yl_kork")])

preprocessed_paavo_data <- subset(preprocessed_paavo_data, select=-c(ko_yliop,
                                                           ko_ammat, ko_al_kork,
                                                                     ko_yl_kork))




final_data <-
  left_join(summarised_donor_data,
            preprocessed_paavo_data,
            by = c("zip", "Year")) %>% 
  filter(Year > 2014)
```

# Preliminary plots

```{r}
final_data %>% 
  ggplot(aes(x = medianincome)) +
  geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )


```
```{r}
final_data %>% 
  ggplot(aes(x = averageincome)) +
  geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )
```


```{r}
final_data %>% 
  ggplot(aes(x = averageincome)) +
  geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. ) +
  scale_y_log10()
```

```{r}
final_data %>% 
  ggplot(aes(x = Year, y = averageincome)) +
  geom_jitter(alpha = 0.2)
```





```{r} 
final_data %>% 
ggplot(aes(x = Basiceducation)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )


```
```{r}
final_data %>% 
ggplot(aes(x = secondaryeducation)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )

```

```{r}
final_data %>% 
ggplot(aes(x = tertiaryeducation)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )
```

# Plotting housing variables 
```{r}
final_data  %>% 
ggplot(aes(x = owner_apartment)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )

final_data  %>% 
ggplot(aes(x = rental_apartment)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )

```

# Plotting main type of activity 
```{r}
final_data  %>% 
ggplot(aes(x = unemployed)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )

final_data  %>% 
ggplot(aes(x = employed)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )

final_data  %>% 
ggplot(aes(x = students)) +
geom_histogram(binwidth = 1000) +
  facet_grid(Year ~. )


```


  
# summarised by hb 
```{r}

hb_by_zip <- final_data %>% 
  group_by(zip, Year) %>% 
  summarise(mean_hb=mean(mean_hb)) 

hb_by_zip %>% 
  ggplot(aes(x = Year, y = mean_hb)) +
  geom_jitter(alpha = 0.2)


```






# correlation matrix and plots

```{r}
library("GGally")

ggpairs(final_data,columns = 



```


# Compare the  distribution of blood donors to Finnish average distribution

```{r}
testi1 <- final_data %>% 
group_by(donor,Year,population18)

 testi1 %>% 
  ggplot(aes(x=Basiceducation, y=population18)) +
  geom_jitter(alpha= 0.2)  +
 facet_grid(Year ~.)
 
 testi1 %>% 
  ggplot(aes(x=tertiaryeducation, y= population18)) +
 geom_jitter(alpha= 0.2)+ 
   facet_grid(Year ~.)
 
 testi1 %>% 
   ggplot(aes(x=secondaryeducation, y=population18)) +
   geom_jitter (alpha=0.2) +
   facet_grid(Year ~.)
```

# Count division of post codes between mobile and fixed sites.  (Calculate the average distance between zip code and donation site for modelling purposes). 
```{r}

```


# clustering the zip codes 
