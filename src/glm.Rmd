---
title: "glm"
author: "Ilpo Arminen"
date: "8/21/2019"
output: github_document
---
This code is based on https://github.com/FRCBS/iron_levels_of_blood_donors script https://github.com/FRCBS/iron_levels_of_blood_donors/blob/master/src/index.Rmd by Muriel Lobier and published in https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0220862 

```{r}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(viridis)
library(stargazer)
library(ggfortify)
library(car)
library(MASS)
library(relaimpo)
library(broom)
```


```{r}
load("/home/ilpo/Paavo/data/modified_data.RData")
```

  standardization:
   * All  variables are centered only. They are not standardized to increase interpretability of the coefficients.
   * They are not standardized also to highight that using std coeffs does not enable comparison between groups as SDs of different groups are different.  Is this suitable for poisson/negative binomial?
```{r}
data <- modified_data %>% mutate(higher_education= scale(proportion_inhabitants_with_higher_education,scale=FALSE)[,1],
                eligible_population= scale(eligible_population,scale=FALSE)[,1],
                medianincome = scale(medianincome,scale=FALSE)[,1],
                minDistkm. = scale((minDistkm),scale=FALSE)[,1])
               # prop_donors= scale(prop_donors,scale=FALSE[1])) 
```
   # Making regression model for new donors and repeated donors separately 
   # Poisson and negative binomial regression 


```{r,warning=FALSE} 
repeat_dn.poisson <- glm(prop_donors ~ medianincome + higher_education + eligible_population + minDistkm, data=modified_data,family=poisson)  #repeated donors
new_dn.poisson <- glm(prop_new_donors ~ medianincome + higher_education + eligible_population + minDistkm, data=data, family=poisson)#new donors
```


```{r, warning=FALSE} 
# Lets make binomial model for comparison 
repeat_dn.negabin <- MASS::glm.nb(prop_donors ~ medianincome + higher_education + eligible_population + minDistkm, data=data)
new_dn.negabin<-MASS::glm.nb(prop_new_donors ~ medianincome + higher_education + eligible_population + minDistkm, data=data)

#quasipoisson
repeat_dn.qpoisson <- glm(prop_donors ~ medianincome + higher_education + eligible_population + minDistkm, data=data,family=quasipoisson)  
new_dn.qpoisson <- glm(prop_new_donors ~ medianincome + higher_education + eligible_population + minDistkm, data=data, family=quasipoisson)

```



#Repeat donor autoplots
#Poisson

```{r}
autoplot(repeat_dn.poisson,which = 1:6, ncol = 3, label.size = 3,shape = 1, alpha = 0.7) 
```




#negative binomial
```{r}
autoplot(repeat_dn.negabin,which = 1:6, ncol = 3, label.size = 3,shape = 1, alpha = 0.7) 

```

#quasi-poisson
```{r}
autoplot(repeat_dn.qpoisson,which = 1:6, ncol = 3, label.size = 3,shape = 1, alpha = 0.7)
```


#The key criterion for using a Poisson model is after accounting for the effect of predictors, the mean must equal the variance.
```{r}
plot(repeat_dn.poisson, which = 3)

```

```{r}
plot(repeat_dn.negabin, which = 3)
```

```{r}
plot(repeat_dn.qpoisson, which = 3)

```

#regression tables 
```{r}
summary(repeat_dn.poisson)
```

```{r}
summary(repeat_dn.negabin)
```

```{r}
summary(repeat_dn.qpoisson)
```


#New donors autoplots
```{r}

autoplot(new_dn.poisson,which = 1:6, ncol = 3, label.size = 3,shape = 1, alpha = 0.7)
```


```{r}

autoplot(new_dn.negabin,which = 1:6, ncol = 3, label.size = 3,shape = 1, alpha = 0.7)
```

```{r}
autoplot(new_dn.qpoisson,which = 1:6, ncol = 3, label.size = 3,shape = 1, alpha = 0.7)
```


#new donor regression tables 
```{r}
summary(new_dn.poisson)

```

```{r}
summary(new_dn.negabin)
```

```{r}

summary(new_dn.qpoisson)


```


